name: Test Nautobot Plugin

on:
  push:
    branches: [ main, dev, '6-undersÃ¸ke-testing-med-nautobot-django' ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: nautobot-plugin-praksis
    
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: nautobot
          POSTGRES_PASSWORD: nautobot
          POSTGRES_DB: nautobot
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:6
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Install dependencies
      run: |
        poetry install --no-interaction
    
    - name: Setup development environment
      run: |
        # Create development directory
        mkdir -p development
        
        # Create simple test configuration
        cat > development/nautobot_config.py << 'EOF'
        # Nautobot test configuration
        import os
        import sys

        # Basic settings
        ALLOWED_HOSTS = ["*"]
        SECRET_KEY = "test-key-for-ci"

        # Database settings
        DATABASES = {
            "default": {
                "NAME": "nautobot",
                "USER": "nautobot",
                "PASSWORD": "nautobot",
                "HOST": "localhost",
                "PORT": 5432,
                "ENGINE": "django.db.backends.postgresql",
            }
        }

        # Redis settings
        REDIS = {
            "tasks": {
                "HOST": "localhost",
                "PORT": 6379,
                "PASSWORD": "",
                "DATABASE": 0,
                "SSL": False,
            },
            "caching": {
                "HOST": "localhost",
                "PORT": 6379,
                "PASSWORD": "",
                "DATABASE": 1,
                "SSL": False,
            }
        }

        # Create directories
        BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
        for dirname in ["media", "static", "reports", "scripts", "git", "jobs", "logs"]:
            os.makedirs(os.path.join(BASE_DIR, dirname), exist_ok=True)

        # Set paths
        MEDIA_ROOT = os.path.join(BASE_DIR, "media")
        STATIC_ROOT = os.path.join(BASE_DIR, "static")
        REPORTS_ROOT = os.path.join(BASE_DIR, "reports")
        SCRIPTS_ROOT = os.path.join(BASE_DIR, "scripts")
        GIT_ROOT = os.path.join(BASE_DIR, "git")
        JOBS_ROOT = os.path.join(BASE_DIR, "jobs")
        LOG_DIR = os.path.join(BASE_DIR, "logs")

        # Enable the plugin
        PLUGINS = ["praksis_nhn_nautobot"]
        PLUGINS_CONFIG = {}
        EOF

    - name: Run tests
      run: |
        export NAUTOBOT_ROOT=$(pwd)
        export NAUTOBOT_CONFIG=development/nautobot_config.py
        
        # Run migrations and tests through Poetry
        poetry run nautobot-server migrate
        poetry run nautobot-server test praksis_nhn_nautobot
    
    - name: Generate coverage report
      run: |
        export NAUTOBOT_ROOT=$(pwd)
        export NAUTOBOT_CONFIG=development/nautobot_config.py
        poetry run pytest --cov=praksis_nhn_nautobot praksis_nhn_nautobot/tests/
        poetry run coverage xml
    
    - name: Run linting
      run: |
        poetry run black --check praksis_nhn_nautobot
        poetry run flake8 praksis_nhn_nautobot
        poetry run pylint --disable=all --enable=unused-import praksis_nhn_nautobot