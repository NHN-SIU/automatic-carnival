{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Graph view</h3>
      </div>
      <div class="panel-body">
        <!-- Label Configuration Toolbox -->
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#labelOptions" class="collapsed">
                Label Options <span class="glyphicon glyphicon-menu-down"></span>
              </a>
            </h4>
          </div>
          <div id="labelOptions" class="panel-collapse collapse">
            <div class="panel-body">
              <form id="labelConfigForm">
                <div class="row">
                  <div class="col-md-3">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" value="sambandsnummer"> Sambandsnummer
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" value="bandwidth"> Bandwidth
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" value="status"> Status
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" value="type"> Type
                      </label>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-3">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" value="vendor"> Vendor
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" value="location"> Location
                      </label>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="checkbox">
                      <label>
                        <input type="checkbox" value="transporttype"> Transport Type
                      </label>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div id="network-container" style="height: 600px; width: 100%;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Include vis.js library -->
<script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.2/dist/vis-network.min.js"></script>
{{ network_data.nodes|json_script:"nodes-data" }}
{{ network_data.edges|json_script:"edges-data" }}
{{ network_options|json_script:"options-data" }}
{{ network_data.nodes|json_script:"full-nodes-data" }}

<script type="text/javascript">
  const container = document.getElementById('network-container');
  
  // Get data from json_script tags
  const nodesData = JSON.parse(document.getElementById('nodes-data').textContent);
  const edgesData = JSON.parse(document.getElementById('edges-data').textContent);
  const fullNodesData = JSON.parse(document.getElementById('full-nodes-data').textContent);
  
  // Create a map for quick lookup of node data by ID
  const nodeDataMap = {};
  fullNodesData.forEach(node => {
    nodeDataMap[node.id] = node;
  });
  
  const nodes = new vis.DataSet(nodesData);
  const edges = new vis.DataSet(edgesData);
  const data = {
    nodes: nodes,
    edges: edges
  };
  
  const options = JSON.parse(document.getElementById('options-data').textContent);
  const network = new vis.Network(container, data, options);

  // Function to update node labels based on selected options
  function updateNodeLabels() {
    const checkedOptions = Array.from(document.querySelectorAll('#labelConfigForm input:checked:not([disabled])'))
      .map(input => input.value);
    
    // Update each node's label
    nodes.forEach(node => {
      const nodeData = nodeDataMap[node.id];
      if (!nodeData) return;
      
      let label = [];
      // Always add name in bold
      if (nodeData.name) {
        label.push(`<b>${nodeData.name}</b>`);
      }
      
      // Add other selected properties
      checkedOptions.forEach(option => {
        if (nodeData[option] && option !== 'name') {
          label.push(`${nodeData[option]}`);
        }
      });
      
      nodes.update({
        id: node.id,
        label: label.join('\n')
      });
    });
  }

  // Add event listeners to checkboxes
  document.querySelectorAll('#labelConfigForm input[type="checkbox"]').forEach(checkbox => {
    checkbox.addEventListener('change', updateNodeLabels);
  });

  // Initialize labels
  updateNodeLabels();

  network.on("hoverNode", function(params) {
    const hoveredNodeId = params.node;
    const connectedEdges = network.getConnectedEdges(hoveredNodeId);
    const connectedNodes = network.getConnectedNodes(hoveredNodeId);
    
    // Dim all nodes except hovered and connected
    nodes.getIds().forEach(nodeId => {
      if (nodeId !== hoveredNodeId && !connectedNodes.includes(nodeId)) {
        nodes.update({
          id: nodeId,
          color: {
            background: '#EEEEEE',
            border: '#CCCCCC'
          },
          opacity: 1
        });
      }
    });

    // Process each connected edge
    connectedEdges.forEach(edgeId => {
      const edgeData = edges.get(edgeId);
      
      if (edgeData.from === hoveredNodeId) {
        // Outgoing edge - highlight red
        edges.update({
          id: edgeId,
          color: '#E53935',
          width: 3,
          shadow: true
        });
      } else if (edgeData.to === hoveredNodeId) {
        // Incoming edge - highlight green
        edges.update({
          id: edgeId,
          color: '#008000',
          width: 3,
          shadow: true
        });
      }
    });
  });

    // Add blur handler to restore original colors
    network.on("blurNode", function() {
    // Restore all nodes to original colors
    nodes.getIds().forEach(nodeId => {
      nodes.update({
        id: nodeId,
        color: {
      border: '#2B7CE9',
      background: '#97C2FC'},
        opacity: 1
      });
    });
    
    // Restore all edges to original colors
    edges.getIds().forEach(edgeId => {
      edges.update({
        id: edgeId,
        color: "#848484",
        width: 1,
        shadow: false
      });
    });
  });

  // Add click handler to navigate to focused view (keep existing code)
  network.on("click", function(params) {
    // Check if a node was clicked
    if (params.nodes && params.nodes.length > 0) {
      const nodeId = params.nodes[0];
      
      // Navigate to the focused view for this node
      window.location.href = `/plugins/praksis-nhn-nautobot/samband/graph/${nodeId}/`;
    }
  });
</script>
{% endblock %}