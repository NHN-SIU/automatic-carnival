{% extends 'base.html' %}
{% load static %}

{% block title %}Network Connections Map{% endblock %}

{% block content %}
<!-- Main container with flex layout -->
<div style="display: flex; flex-direction: row; width: 100%; padding: 20px; gap: 20px; height: calc(100vh - 100px);">
  <!-- Left side filters -->
  <div style="flex: 0 0 280px; background-color: #f8f9fa; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; display: flex; flex-direction: column; height: 100%;">
    <a href="{% url 'plugins:praksis_nhn_nautobot:samband_list' %}" class="btn btn-outline-secondary">Back to List</a>
    <!-- Scrollable filter content -->
    <div style="flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 70px;">
      <h5 style="margin-top: 0; margin-bottom: 15px; font-size: 16px;">Filter Connections</h5>
      
      <!-- Geographic filters -->
      <div style="margin-bottom: 15px;">
        <strong style="font-size: 14px;">Geographic Location:</strong>
        <div style="margin-top: 5px;">
          <label style="font-size: 13px; display: block; margin-bottom: 3px;">Latitude:</label>
          <input type="number" step="0.000001" id="lat" name="lat" placeholder="e.g. 59.911491" 
                 value="{{ lat|default:'' }}" style="width: 100%; padding: 4px; font-size: 13px; margin-bottom: 5px;">
        </div>
        <div style="margin-top: 5px;">
          <label style="font-size: 13px; display: block; margin-bottom: 3px;">Longitude:</label>
          <input type="number" step="0.000001" id="lng" name="lng" placeholder="e.g. 10.757933" 
                 value="{{ lng|default:'' }}" style="width: 100%; padding: 4px; font-size: 13px; margin-bottom: 5px;">
        </div>
        <div style="margin-top: 5px;">
          <label style="font-size: 13px; display: block; margin-bottom: 3px;">Radius (km):</label>
          <input type="number" step="1" min="0" max="1000" id="radius" name="radius" value="{{ radius|default:'50' }}" 
                 style="width: 100%; padding: 4px; font-size: 13px; margin-bottom: 5px;">
        </div>
        <div style="margin-top: 8px;">
          <div>
            <input type="checkbox" id="useCurrentLocation" name="useCurrentLocation"> 
            <label for="useCurrentLocation" style="font-size: 13px;">Use my location</label>
          </div>
        </div>
      </div>
      
      <!-- Place Pin button -->
      <div style="margin-bottom: 15px;">
        <button id="pin-toggle" class="btn btn-outline-primary btn-sm" style="width: 100%; padding: 8px;">Place Pin on Map</button>
      </div>
      
      <!-- Vendor filters -->
      <div style="margin-bottom: 15px;">
        <strong style="font-size: 14px;">Vendors:</strong><br>
        <div style="max-height: 100px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; margin-top: 5px;">
          {% if vendors %}
            {% for vendor in vendors %}
            <div>
              <input type="checkbox" id="vendor-{{ forloop.counter }}" name="vendors" value="{{ vendor }}" 
                     {% if vendor in selected_vendors %}checked{% endif %}> 
              <label for="vendor-{{ forloop.counter }}" style="font-size: 13px;">{{ vendor }}</label>
            </div>
            {% endfor %}
          {% else %}
            <div style="font-size: 13px; color: #6c757d;">No vendors available</div>
          {% endif %}
        </div>
      </div>
      
      <!-- Status filters -->
      <div style="margin-bottom: 15px;">
        <strong style="font-size: 14px;">Status:</strong><br>
        <div style="max-height: 100px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; margin-top: 5px;">
          {% if statuses %}
            {% for status in statuses %}
            <div>
              <input type="checkbox" id="status-{{ forloop.counter }}" name="statuses" value="{{ status }}"
                     {% if status in selected_statuses %}checked{% endif %}> 
              <label for="status-{{ forloop.counter }}" style="font-size: 13px;">{{ status }}</label>
            </div>
            {% endfor %}
          {% else %}
            <div style="font-size: 13px; color: #6c757d;">No statuses available</div>
          {% endif %}
        </div>
      </div>
      
      <!-- City filters -->
      <div style="margin-bottom: 15px;">
        <strong style="font-size: 14px;">City:</strong><br>
        <div style="max-height: 100px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; margin-top: 5px;">
          {% if citylist %}
            {% for city in citylist %}
            <div>
              <input type="checkbox" id="city-{{ forloop.counter }}" name="location" value="{{ city }}"
                     {% if city in selected_citylist %}checked{% endif %}> 
              <label for="city-{{ forloop.counter }}" style="font-size: 13px;">{{ city }}</label>
            </div>
            {% endfor %}
          {% else %}
            <div style="font-size: 13px; color: #6c757d;">No cities available</div>
          {% endif %}
        </div>
      </div>
      
      <!-- Location type filters -->
      <div style="margin-bottom: 15px;">
        <strong style="font-size: 14px;">Location Type:</strong><br>
        <div style="max-height: 100px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; margin-top: 5px;">
          {% if location_types %}
            {% for location_type in location_types %}
            <div>
              <input type="checkbox" id="loc-type-{{ forloop.counter }}" name="location_type" value="{{ location_type }}"
                     {% if location_type in selected_location_types %}checked{% endif %}> 
              <label for="loc-type-{{ forloop.counter }}" style="font-size: 13px;">{{ location_type }}</label>
            </div>
            {% endfor %}
          {% else %}
            <div style="font-size: 13px; color: #6c757d;">No location types available</div>
          {% endif %}
        </div>
      </div>
      
      <!-- Transport type filters -->
      <div style="margin-bottom: 15px;">
        <strong style="font-size: 14px;">Transport Type:</strong><br>
        <div style="max-height: 100px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 8px; margin-top: 5px;">
          {% if transport_types %}
            {% for transport_type in transport_types %}
            <div>
              <input type="checkbox" id="trans-type-{{ forloop.counter }}" name="transport_type" value="{{ transport_type }}"
                     {% if transport_type in selected_transport_types %}checked{% endif %}> 
              <label for="trans-type-{{ forloop.counter }}" style="font-size: 13px;">{{ transport_type }}</label>
            </div>
            {% endfor %}
          {% else %}
            <div style="font-size: 13px; color: #6c757d;">No transport types available</div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Fixed button area at the bottom -->
    <div style="position: absolute; bottom: 0; left: 0; right: 0; padding: 15px; background-color: #f8f9fa; border-top: 1px solid #dee2e6; border-radius: 0 0 5px 5px; display: flex; justify-content: space-between;">
      <button id="apply-filters" class="btn btn-primary btn-sm" style="flex: 1; margin-right: 8px;">Apply Filters</button>
      <button id="reset-filters" class="btn btn-secondary btn-sm" style="flex: 1;">Reset</button>
    </div>
  </div>
  
  <!-- Right side map -->
  <div style="flex: 1; position: relative; height: 100%;">
    <!-- Map container -->
    <div id="leaflet" style="width: 100%; height: 100%; border: 1px solid #ccc; border-radius: 5px;"></div>

    <!-- Loading indicator -->
    <div id="loading-indicator" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.8); padding: 15px; border-radius: 5px; display: none; z-index: 1000;">
      <div style="text-align: center;">Loading connections...</div>
    </div>
    
    <!-- Map legend -->
    <div style="position: absolute; top: 10px; right: 10px; background-color: white; padding: 10px; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.2); z-index: 500; max-width: 200px;">
      <div style="font-weight: bold; margin-bottom: 5px;">Status</div>
      <div style="display: flex; align-items: center; margin-bottom: 3px;">
        <div style="width: 16px; height: 3px; background-color: #4CAF50; margin-right: 5px;"></div>
        <span style="font-size: 12px;">Active</span>
      </div>
      <div style="display: flex; align-items: center; margin-bottom: 3px;">
        <div style="width: 16px; height: 3px; background-color: #FFC107; margin-right: 5px;"></div>
        <span style="font-size: 12px;">Planned/Planning</span>
      </div>
      <div style="display: flex; align-items: center; margin-bottom: 8px;">
        <div style="width: 16px; height: 3px; background-color: #F44336; margin-right: 5px;"></div>
        <span style="font-size: 12px;">Decommissioned</span>
      </div>
      
      <div style="font-weight: bold; margin-bottom: 5px; margin-top: 8px;">Location Type</div>
      <div id="location-type-legend">
        <!-- Location type icons will be added dynamically -->
      </div>
    </div>
    
    <!-- Connection count badge -->
    <div style="position: absolute; bottom: 10px; left: 10px; background-color: #3186cc; color: white; padding: 5px 10px; border-radius: 20px; z-index: 400; font-size: 14px;" id="connection-count">
      Loading...
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Global variables
  var activeMarker = null;
  var activeLines = [];
  var previouslyActiveMarkers = [];
  var featureIdToMarkers = {};
  var featureIdToLines = {};
  var locationMarker = null;
  var radiusMarker = null;
  var currentRadius = 0;
  var targetRadius = 0;
  var animationInProgress = false;
  var pinPlacementMode = false;
  var selectedConnectionId = null;
  
  // Status color mapping
  const statusColors = {
    'Active': '#4CAF50',     // Green
    'Planned': '#FFC107',    // Yellow/Amber
    'Decommissioned': '#F44336', // Red
    'Planning': '#FFC107',   // Yellow
    'Unknown': '#9E9E9E'     // Grey (fallback)
  };
  
  // Location type icon mapping - using only the most relevant types
  const locationTypeIcons = {
    'Hospital': {
      icon: 'fa-solid fa-hospital',
      color: '#E91E63',
      size: [24, 24]
    },
    // 'Datacenter': {
    //   icon: 'fa-solid fa-server',
    //   color: '#673AB7',
    //   size: [24, 24]
    // },
    'Data Center': {
      icon: 'fa-solid fa-server',
      color: '#673AB7',
      size: [24, 24]
    },
    'Pharmacy': {
      icon: 'fa-solid fa-prescription-bottle-medical',
      color: '#009688',
      size: [24, 24]
    },
    'Primary Care': {
      icon: 'fa-solid fa-user-doctor',
      color: '#FF5722',
      size: [24, 24]
    },
    'Medical Imaging': {
      icon: 'fa-solid fa-x-ray',
      color: '#8BC34A',
      size: [24, 24]
    }
  };
  
  // Populate location type legend dynamically with only relevant types
  const locationTypeLegend = document.getElementById('location-type-legend');
  for (const [type, config] of Object.entries(locationTypeIcons)) {
    const item = document.createElement('div');
    item.style.display = 'flex';
    item.style.alignItems = 'center';
    item.style.marginBottom = '3px';
    
    item.innerHTML = `
      <div style="width: 16px; margin-right: 5px; text-align: center;">
        <i class="${config.icon}" style="color: ${config.color}; font-size: 12px;"></i>
      </div>
      <span style="font-size: 12px;">${type}</span>
    `;
    
    locationTypeLegend.appendChild(item);
  }

  // Create a custom icon for a location type
  function createLocationIcon(locationType) {
    const config = locationTypeIcons[locationType] || {
      icon: 'fa-solid fa-location-dot',
      color: '#3186cc',
      size: [24, 24]
    };
    
    return L.divIcon({
      html: `<div style="background-color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
              <i class="${config.icon}" style="color: ${config.color}; font-size: 14px;"></i>
            </div>`,
      className: '',
      iconSize: config.size,
      iconAnchor: [12, 12],
      popupAnchor: [0, -12]
    });
  }
  
  // Get status color or default
  function getStatusColor(status) {
    return statusColors[status] || statusColors['Unknown'];
  }

  // Initialize map
  var map = new L.Map('leaflet', {
    center: [65.4, 17.0],
    zoom: 6,
    preferCanvas: true
  });

  // Add basemap layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19
  }).addTo(map);

  // Layer groups
  var pointsLayer = L.layerGroup().addTo(map);
  var connectionsLayer = L.layerGroup().addTo(map);
  var radiusLayer = L.layerGroup().addTo(map);

  // Reset active elements for highlighting
  function resetActiveElements() {
    if (selectedConnectionId) {
      // Reset all previously active markers
      if (featureIdToMarkers[selectedConnectionId]) {
        featureIdToMarkers[selectedConnectionId].forEach(function(marker) {
          // Reset marker icon size or style
          const icon = marker.getIcon();
          icon.options.html = icon.options.html.replace('width: 32px; height: 32px', 'width: 24px; height: 24px')
                                              .replace('font-size: 18px', 'font-size: 14px');
          icon.options.iconSize = [24, 24];
          icon.options.iconAnchor = [12, 12];
          marker.setIcon(icon);
        });
      }
      
      // Reset active lines
      if (featureIdToLines[selectedConnectionId]) {
        featureIdToLines[selectedConnectionId].forEach(function(line) {
          // Use status-based color with opacity
          const statusColor = getStatusColor(line.options.status || 'Unknown');
          line.setStyle({
            color: statusColor,
            weight: 2.5,
            opacity: 0.8
          });
        });
      }
    }
    
    selectedConnectionId = null;
    activeMarker = null;
    activeLines = [];
  }

  // Highlight connection elements
  function highlightConnection(connectionId) {
    selectedConnectionId = connectionId;
    if (featureIdToMarkers[connectionId]) {
      featureIdToMarkers[connectionId].forEach(function(marker) {
        // Increase icon size for highlighting
        const icon = marker.getIcon();
        
        // Update both the icon size AND the icon anchor point
        icon.options.html = icon.options.html.replace('width: 24px; height: 24px', 'width: 32px; height: 32px')
                                          .replace('font-size: 14px', 'font-size: 18px');
        
        // Update the icon anchor to center the larger icon
        icon.options.iconSize = [32, 32];    // Update to match new size
        icon.options.iconAnchor = [16, 16];  // Center point of the new size
        
        marker.setIcon(icon);
        marker.setZIndexOffset(10); // Bring to front
      });
    }
    
    if (featureIdToLines[connectionId]) {
      featureIdToLines[connectionId].forEach(function(line) {
        line.setStyle({
          color: '#0000FF',  // Blue line for selected connections
          weight: 4,
          opacity: 0.8
        });
        line.bringToFront();
        activeLines.push(line);
      });
    }
  }

  // Fetch connection details
  function fetchConnectionDetails(connectionId, callback) {
    fetch(`/plugins/praksis-nhn-nautobot/samband/map-data/?connection_id=${connectionId}`)
      .then(response => response.json())
      .then(data => {
        console.log("Connection details received:", data);
        callback(data);
      })
      .catch(error => {
        console.error("Error fetching connection details:", error);
        callback({ error: 'Could not load connection details' });
      });
  }

  // Load map data - optimized to request minimal data
  function loadMapData(params) {
    resetActiveElements();
    featureIdToMarkers = {};
    featureIdToLines = {};
    
    document.getElementById('loading-indicator').style.display = 'block';
    document.getElementById('connection-count').textContent = 'Loading...';
    
    var url = '/plugins/praksis-nhn-nautobot/samband/map-data/';
    if (params) {
      url += '?' + params;
      // Always include status for coloring
      if (params.indexOf('include_fields') === -1) {
        url += '&include_fields=status&include_fields=location_type';
      } else if (params.indexOf('include_fields=status') === -1) {
        url += '&include_fields=status&include_fields=location_type';
      }
    } else {
      url += '?include_fields=status&include_fields=location_type';
    }
    
    fetch(url)
      .then(response => {
        if (!response.ok) {
          throw new Error(`Network response was not ok (${response.status})`);
        }
        return response.json();
      })
      .then(data => {
        console.log(`Received ${data.count} connections:`, data);
        processMapData(data);
      })
      .catch(error => {
        console.error("Error loading map data:", error);
        document.getElementById('connection-count').textContent = '0 connections';
      })
      .finally(() => {
        document.getElementById('loading-indicator').style.display = 'none';
      });
  }

  // Process data using font awesome icons for points
  function processMapData(data) {
    document.getElementById('connection-count').textContent = 
      `${data.count || 0} connection${data.count !== 1 ? 's' : ''}`;
    
    pointsLayer.clearLayers();
    connectionsLayer.clearLayers();
    radiusLayer.clearLayers();
    
    if (data.connections && data.connections.length > 0) {
      var bounds = [];
      
      data.connections.forEach(function(connection) {
        const connectionId = connection.id;
        const pointA = connection.point_a;
        const pointB = connection.point_b;
        const status = connection.status || 'Unknown';
        const locationType = connection.location_type || 'Unknown';
        
        // Skip if either point doesn't have location data
        if (!pointA.location || !pointB.location) return;
        
        // Determine colors for status
        const statusColor = getStatusColor(status);
        
        // Create Point A marker with FontAwesome icon
        var markerA = L.marker(pointA.location, {
          icon: createLocationIcon(locationType)
        });
        
        markerA.bindTooltip(connection.name);
        markerA.on('click', function() {
          resetActiveElements();
          
          // Show popup
          fetchConnectionDetails(connectionId, function(details) {
            if (details.error) return;
            
            var popupContent = `
            <div style="min-width: 200px; max-width: 250px;">
              <strong>${connection.name} - Point A</strong><br>
              <strong>Status:</strong> ${status}<br>
              <strong>Bandwidth:</strong> ${details.bandwidth || 'N/A'}<br>
              <strong>Vendor:</strong> ${details.vendor || 'N/A'}<br>
              <strong>Type:</strong> ${details.type_name || 'N/A'}<br>
              <a href="/plugins/praksis-nhn-nautobot/samband/map/${connectionId}/" class="btn btn-primary btn-xs" style="color: white; font-size: 11px; padding: 2px 5px; margin-top: 5px;">View Details</a>
              </div>
              `;
              
              markerA.bindPopup(popupContent).openPopup();
              highlightConnection(connectionId);
          });
        });
        
        // Create Point B marker with FontAwesome icon
        var markerB = L.marker(pointB.location, {
          icon: createLocationIcon(locationType)
        });
        
        markerB.bindTooltip(connection.name);
        markerB.on('click', function() {
          resetActiveElements();
          
          // Show popup
          fetchConnectionDetails(connectionId, function(details) {
            if (details.error) return;
            
            var popupContent = `
            <div style="min-width: 200px; max-width: 250px;">
              <strong>${connection.name} - Point B</strong><br>
              <strong>Status:</strong> ${status}<br>
                <strong>Bandwidth:</strong> ${details.bandwidth || 'N/A'}<br>
                <strong>Vendor:</strong> ${details.vendor || 'N/A'}<br>
                <strong>Type:</strong> ${details.type_name || 'N/A'}<br>
                <a href="/plugins/praksis-nhn-nautobot/samband/map/${connectionId}/" class="btn btn-primary btn-xs" style="color: white; font-size: 11px; padding: 2px 5px; margin-top: 5px;">View Details</a>
                </div>
                `;
                
                markerB.bindPopup(popupContent).openPopup();
                highlightConnection(connectionId);
          });
        });
        
        // Create connection line with status-based color
        var line = L.polyline([pointA.location, pointB.location], {
          color: statusColor,
          weight: 2.5,
          opacity: 0.8,
          smoothFactor: 1,
          status: status
        });
        
        line.bindTooltip(connection.name);
        line.on('click', function(e) {
          resetActiveElements();
          
          // Show popup
          fetchConnectionDetails(connectionId, function(details) {
            if (details.error) return;
            
            var popupContent = `
            <div style="min-width: 200px; max-width: 250px;">
              <strong>${connection.name}</strong><br>
              <strong>Status:</strong> ${status}<br>
              <strong>Bandwidth:</strong> ${details.bandwidth || 'N/A'}<br>
              <strong>Vendor:</strong> ${details.vendor || 'N/A'}<br>
              <strong>Type:</strong> ${details.type_name || 'N/A'}<br>
              <a href="/plugins/praksis-nhn-nautobot/samband/map/${connectionId}/" class="btn btn-primary btn-xs" style="color: white; font-size: 11px; padding: 2px 5px; margin-top: 5px;">View Details</a>
              </div>
              `;
              
              // First unbind any existing popup
              line.unbindPopup();
              
              // Apply highlight BEFORE binding popup
              highlightConnection(connectionId);
              
              // Create popup at the click location instead of line center
              L.popup()
                .setLatLng(e.latlng)
                .setContent(popupContent)
                .openOn(map);
          });
        });
        
        // Store references for highlighting
        if (!featureIdToMarkers[connectionId]) featureIdToMarkers[connectionId] = [];
        featureIdToMarkers[connectionId].push(markerA, markerB);
        
        if (!featureIdToLines[connectionId]) featureIdToLines[connectionId] = [];
        featureIdToLines[connectionId].push(line);
        
        // Add to map
        markerA.addTo(pointsLayer);
        markerB.addTo(pointsLayer);
        line.addTo(connectionsLayer);
        
        // Track bounds for fitting view
        bounds.push(pointA.location);
        bounds.push(pointB.location);
      });
      
      // Fit map to bounds
      if (bounds.length > 0) map.fitBounds(bounds);
    } else {
      L.marker([65.4, 17.0])
        .addTo(pointsLayer)
        .bindPopup('No connection data available')
        .openPopup();
    }
    
    // Add radius circle if specified
    if (data.radius) {
      L.circle(data.radius.location, {
        radius: data.radius.radius_km * 1000,
        color: '#ff7800',
        weight: 1,
        fillColor: '#ff7800',
        fillOpacity: 0.2,
      }).addTo(radiusLayer);
    }
  }

  // Pin and location functions
  function remove_pin() {
    if (locationMarker) {
      map.removeLayer(locationMarker);
      locationMarker = null;
    }
      
    if (radiusMarker) {
      radiusLayer.clearLayers();
      radiusMarker = null;
    }
    
    var pinToggleBtn = document.getElementById('pin-toggle');
    pinToggleBtn.textContent = 'Place Pin on Map';
    pinToggleBtn.classList.remove('btn-outline-danger');
    pinToggleBtn.classList.add('btn-outline-primary');
    pinPlacementMode = false;
  }

  function animateRadiusChange() {
    if (!radiusMarker || currentRadius === targetRadius) {
      animationInProgress = false;
      return;
    }
    
    animationInProgress = true;
    const step = Math.max(0.5, Math.abs(targetRadius - currentRadius) * 0.1);
    
    if (currentRadius < targetRadius) {
      currentRadius = Math.min(targetRadius, currentRadius + step);
    } else {
      currentRadius = Math.max(targetRadius, currentRadius - step);
    }
    
    radiusMarker.setRadius(currentRadius * 1000);
    
    if (Math.abs(currentRadius - targetRadius) > 0.1) {
      requestAnimationFrame(animateRadiusChange);
    } else {
      currentRadius = targetRadius;
      radiusMarker.setRadius(currentRadius * 1000);
      animationInProgress = false;
    }
  }

  function update_radius_circle(lat, lng, radiusKm) {
    radiusKm = parseFloat(radiusKm) || 50;
    targetRadius = radiusKm;
    
    if (!radiusMarker) {
      currentRadius = 0;
      radiusMarker = L.circle([lat, lng], {
        radius: 0,
        color: '#ff7800',
        weight: 1,
        fillColor: '#ff7800',
        fillOpacity: 0.2,
      }).addTo(radiusLayer);
      
      animateRadiusChange();
    } else {
      radiusMarker.setLatLng([lat, lng]);
      
      if (!animationInProgress) {
        animateRadiusChange();
      }
    }
  }

  function update_pos_point_to_map(lat, lng, radiusKm) {
    if (!locationMarker) {
      locationMarker = L.marker([lat, lng], {
        draggable: true,
        icon: L.divIcon({
          className: 'location-marker',
          html: '<div style="position: absolute; top: -7px; left: -7px; background-color: #ff7800; width: 14px; height: 14px; border-radius: 50%; border: 2px solid #000000;"></div>',
          iconSize: [0, 0],
          iconAnchor: [0, 0]
        })
      }).addTo(map);
      
      // Setup drag handler
      locationMarker.on('drag', function(event) {
        var position = event.target.getLatLng();
        document.getElementById('lat').value = position.lat.toFixed(6);
        document.getElementById('lng').value = position.lng.toFixed(6);
        var currentRadiusKm = parseFloat(document.getElementById('radius').value) || 50;
        update_radius_circle(position.lat, position.lng, currentRadiusKm);
      });
      
      var pinToggleBtn = document.getElementById('pin-toggle');
      pinToggleBtn.textContent = 'Remove Pin';
      pinToggleBtn.classList.remove('btn-outline-info', 'btn-outline-primary');
      pinToggleBtn.classList.add('btn-outline-danger');
    } else {
      locationMarker.setLatLng([lat, lng]);
    }
    
    update_radius_circle(lat, lng, radiusKm);
  }

  function updateFromCoordinateInputs() {
    var lat = parseFloat(document.getElementById('lat').value);
    var lng = parseFloat(document.getElementById('lng').value);
    var radiusKm = parseFloat(document.getElementById('radius').value) || 50;
    
    if (!isNaN(lat) && !isNaN(lng)) {
      update_pos_point_to_map(lat, lng, radiusKm);
    }
  }

  // Click on empty map area to clear selection
  map.on('click', function(e) {
    if (!pinPlacementMode) {
      resetActiveElements();
    } else {
      // Place pin mode
      currentRadius = 0;
      var lat = e.latlng.lat;
      var lng = e.latlng.lng;
      var radiusKm = parseFloat(document.getElementById('radius').value) || 50;
      
      document.getElementById('lat').value = lat.toFixed(6);
      document.getElementById('lng').value = lng.toFixed(6);
      
      update_pos_point_to_map(lat, lng, radiusKm);
      
      var pinToggleBtn = document.getElementById('pin-toggle');
      pinToggleBtn.textContent = 'Remove Pin';
      pinToggleBtn.classList.remove('btn-outline-info', 'btn-outline-primary');
      pinToggleBtn.classList.add('btn-outline-danger');
      pinPlacementMode = false;
    }
  });

  // Event listeners
  document.getElementById('pin-toggle').addEventListener('click', function() {
    if (locationMarker) {
      remove_pin();
    } else {
      this.textContent = 'Click Map to Place Pin';
      this.classList.remove('btn-outline-primary');
      this.classList.add('btn-outline-info');
      pinPlacementMode = true;
    }
  });

  document.getElementById('apply-filters').addEventListener('click', function() {
    var params = new URLSearchParams();
    
    var lat = document.getElementById('lat').value;
    var lng = document.getElementById('lng').value;
    var radius = document.getElementById('radius').value;
    
    if (lat && lng) {
      params.append('lat', lat);
      params.append('lng', lng);
      params.append('radius', radius || '50');
    }
    
    document.querySelectorAll('input[name="vendors"]:checked').forEach(function(checkbox) {
      params.append('vendor', checkbox.value);
    });
    
    document.querySelectorAll('input[name="statuses"]:checked').forEach(function(checkbox) {
      params.append('status', checkbox.value);
    });
    
    document.querySelectorAll('input[name="location"]:checked').forEach(function(checkbox) {
      params.append('location', checkbox.value);
    });
    
    document.querySelectorAll('input[name="location_type"]:checked').forEach(function(checkbox) {
      params.append('location_type', checkbox.value);
    });
    
    document.querySelectorAll('input[name="transport_type"]:checked').forEach(function(checkbox) {
      params.append('transporttype', checkbox.value);
    });
    
    // Always include these fields
    params.append('include_fields', 'status');
    params.append('include_fields', 'location_type');
    
    loadMapData(params.toString());
  });

  document.getElementById('reset-filters').addEventListener('click', function() {
    document.querySelectorAll('input[type="checkbox"]').forEach(function(checkbox) {
      checkbox.checked = false;
    });
    
    document.getElementById('lat').value = '';
    document.getElementById('lng').value = '';
    document.getElementById('radius').value = '50';
    
    remove_pin();
    loadMapData('include_fields=status&include_fields=location_type');
  });

  document.getElementById('useCurrentLocation').addEventListener('change', function() {
    if (this.checked) {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          function(position) {
            document.getElementById('lat').value = position.coords.latitude.toFixed(6);
            document.getElementById('lng').value = position.coords.longitude.toFixed(6);
            var rad = parseFloat(document.getElementById('radius').value) || 50;
            update_pos_point_to_map(position.coords.latitude, position.coords.longitude, rad);
          }, 
          function(error) {
            console.error("Error getting location:", error);
            alert("Could not get your location. Please enter coordinates manually.");
            document.getElementById('useCurrentLocation').checked = false;
          }
        );
      } else {
        alert("Geolocation is not supported by this browser. Please enter coordinates manually.");
        this.checked = false;
      }
    }
  });

  document.getElementById('lat').addEventListener('input', updateFromCoordinateInputs);
  document.getElementById('lng').addEventListener('input', updateFromCoordinateInputs);
  document.getElementById('radius').addEventListener('input', function() {
    var lat = parseFloat(document.getElementById('lat').value);
    var lng = parseFloat(document.getElementById('lng').value);
    var radiusKm = parseFloat(this.value) || 50;
    
    if (!isNaN(lat) && !isNaN(lng) && radiusMarker) {
      update_radius_circle(lat, lng, radiusKm);
    }
  });

  window.addEventListener('resize', function() {
    map.invalidateSize();
  });

  // Initialize map
  setTimeout(function() {
    map.invalidateSize();
  }, 100);
  
  loadMapData(getURLParameters());
  
  function getURLParameters() {
    const queryString = window.location.search;
    return queryString.startsWith('?') ? queryString.substring(1) : '';
  }
});
</script>
{% endblock %}