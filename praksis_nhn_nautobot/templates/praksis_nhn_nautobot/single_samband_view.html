{% extends 'base.html' %}
{% load static %}

{% block title %}Connection Details{% endblock %}

{% block content %}
<!-- Page header with connection name and details -->
<div class="container-fluid px-4 pb-2">
  <div class="row mb-3">
    <div class="col">
      <h1 class="fs-3 fw-bold mb-1" id="connection-name">Loading connection...</h1>
      <div class="d-flex align-items-center mb-2" id="connection-badges">
        <!-- Status badge will be added dynamically -->
      </div>
      
      <!-- Quick info -->
      <div class="row mb-3" id="quick-info">
        <div class="col-md-6 col-lg-3 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h5 class="card-title fs-6">Vendor</h5>
              <p class="card-text" id="vendor-info">Loading...</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h5 class="card-title fs-6">Connection Type</h5>
              <p class="card-text" id="type-info">Loading...</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h5 class="card-title fs-6">Location</h5>
              <p class="card-text" id="location-info">Loading...</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h5 class="card-title fs-6">Transport Type</h5>
              <p class="card-text" id="transport-info">Loading...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Action buttons -->
    <div class="col-auto d-flex align-items-start">
      <a id="details-link" href="#" class="btn btn-primary me-2">Full Details</a>
      <a href="{% url 'plugins:praksis_nhn_nautobot:samband_client_map' %}" class="btn btn-outline-secondary">Back to Map</a>
    </div>
  </div>

  <!-- Connection map and endpoint details -->
  <div class="row">
    <!-- Map section -->
    <div class="col-lg-8 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">Connection Map</h5>
        </div>
        <div class="card-body p-0">
          <!-- Map container -->
          <div id="connection-map" style="height: 500px; width: 100%;"></div>
          
        </div>
      </div>
    </div>
    
    <!-- Endpoint details section -->
    <div class="col-lg-4">
      <div class="row">
        <!-- Point A details -->
        <div class="col-12 mb-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-light">
              <div class="d-flex align-items-center">
                <div id="point-a-icon" class="me-2" style="width: 24px; height: 24px; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  <i class="fa-solid fa-spinner fa-spin" style="font-size: 14px;"></i>
                </div>
                <h5 class="card-title mb-0">Point A</h5>
              </div>
            </div>
            <div class="card-body" id="point-a-details">
              <div class="text-center">Loading point details...</div>
            </div>
          </div>
        </div>
        
        <!-- Point B details -->
        <div class="col-12 mb-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-light">
              <div class="d-flex align-items-center">
                <div id="point-b-icon" class="me-2" style="width: 24px; height: 24px; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  <i class="fa-solid fa-spinner fa-spin" style="font-size: 14px;"></i>
                </div>
                <h5 class="card-title mb-0">Point B</h5>
              </div>
            </div>
            <div class="card-body" id="point-b-details">
              <div class="text-center">Loading point details...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

<script>
document.addEventListener('DOMContentLoaded', function() {
  const connectionId = "{{ connection_id }}";
  let map = null;
  
  // Status colors
  const statusColors = {
    'Active': '#4CAF50',     // Green
    'Planned': '#FFC107',    // Yellow/Amber
    'Decommissioned': '#F44336', // Red
    'Planning': '#FFC107',   // Yellow
    'Unknown': '#9E9E9E'     // Grey (fallback)
  };
  
  // Status Bootstrap classes
  const statusClasses = {
    'Active': 'bg-success',
    'Planned': 'bg-warning',
    'Decommissioned': 'bg-danger',
    'Planning': 'bg-warning',
    'Unknown': 'bg-secondary'
  };
  
  // Location type icon mapping - using only the most relevant types
  const locationTypeIcons = {
    'Hospital': {
      icon: 'fa-solid fa-hospital',
      color: '#E91E63'
    },
    'Datacenter': {
      icon: 'fa-solid fa-server',
      color: '#673AB7'
    },
    'Data Center': {
      icon: 'fa-solid fa-server',
      color: '#673AB7'
    },
    'Pharmacy': {
      icon: 'fa-solid fa-prescription-bottle-medical',
      color: '#009688'
    },
    'Primary Care': {
      icon: 'fa-solid fa-user-doctor',
      color: '#FF5722'
    },
    'Medical Imaging': {
      icon: 'fa-solid fa-x-ray',
      color: '#8BC34A'
    }
  };
  
  // Initialize map
  function initMap() {
    map = L.map('connection-map');
    
    // Add base map layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(map);
    
    return map;
  }
  
  // Helper function to get icon for location type
  function getLocationIcon(locationType) {
    const config = locationTypeIcons[locationType] || {
      icon: 'fa-solid fa-location-dot',
      color: '#3186cc'
    };
    
    return L.divIcon({
      html: `<div style="background-color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
              <i class="${config.icon}" style="color: ${config.color}; font-size: 16px;"></i>
            </div>`,
      className: '',
      iconSize: [28, 28],
      iconAnchor: [14, 14],
      popupAnchor: [0, -14]
    });
  }
  
  // Render icon for a location
  function renderLocationIcon(elementId, category) {
    const config = locationTypeIcons[category] || {
      icon: 'fa-solid fa-location-dot',
      color: '#3186cc'
    };
    
    document.getElementById(elementId).innerHTML = `<i class="${config.icon}" style="color: ${config.color}; font-size: 14px;"></i>`;
  }
  
  // Render map for the connection
  function renderConnectionMap(data) {
    // Initialize map if not already done
    if (!map) map = initMap();
    
    const bounds = [];
    const statusColor = statusColors[data.status] || statusColors.Unknown;
    
    // Use the coordinates directly from our simplified API response
    const pointACoords = data.pop_a_coords;
    const pointBCoords = data.pop_b_coords;
    
    // Add markers and line if coordinates are valid
    if (pointACoords) {
      L.marker(pointACoords, {
        icon: getLocationIcon(data.pop_a_category)
      }).bindPopup(`
        <div style="min-width: 200px;">
          <strong>${data.name} - Point A</strong><br>
          ${data.pop_a_address ? `<strong>Address:</strong> ${data.pop_a_address}<br>` : ''}
          ${data.pop_a_category ? `<strong>Category:</strong> ${data.pop_a_category}<br>` : ''}
          ${data.pop_a_room ? `<strong>Room:</strong> ${data.pop_a_room}` : ''}
        </div>
      `).addTo(map);
      
      bounds.push(pointACoords);
    }
    
    if (pointBCoords) {
      L.marker(pointBCoords, {
        icon: getLocationIcon(data.pop_b_category)
      }).bindPopup(`
        <div style="min-width: 200px;">
          <strong>${data.name} - Point B</strong><br>
          ${data.pop_b_address ? `<strong>Address:</strong> ${data.pop_b_address}<br>` : ''}
          ${data.pop_b_category ? `<strong>Category:</strong> ${data.pop_b_category}<br>` : ''}
          ${data.pop_b_room ? `<strong>Room:</strong> ${data.pop_b_room}` : ''}
        </div>
      `).addTo(map);
      
      bounds.push(pointBCoords);
    }
    
    if (pointACoords && pointBCoords) {
      L.polyline([pointACoords, pointBCoords], {
        color: statusColor,
        weight: 4,
        opacity: 0.8,
        smoothFactor: 1
      }).bindPopup(`
        <div style="min-width: 200px;">
          <strong>${data.name}</strong><br>
          <strong>Status:</strong> ${data.status || 'Unknown'}<br>
          <strong>Vendor:</strong> ${data.vendor || 'Not specified'}<br>
          <strong>Type:</strong> ${data.type_name || 'Not specified'}
        </div>
      `).addTo(map);
    }
    
    // Set map view
    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [30, 30] });
    } else {
      map.setView([65.4, 17.0], 5);
      
      // Show message if no valid coordinates
      L.marker([65.4, 17.0])
        .bindPopup("No valid coordinates available for this connection")
        .addTo(map)
        .openPopup();
    }
  }
  
  // Populate details for a connection point
  function populatePointDetails(elementId, data, isPointA) {
    const address = isPointA ? data.pop_a_address : data.pop_b_address;
    const category = isPointA ? data.pop_a_category : data.pop_b_category;
    const room = isPointA ? data.pop_a_room : data.pop_b_room;
    const coords = isPointA ? data.pop_a_coords : data.pop_b_coords;
    
    let html = '';
    
    if (address) {
      html += `<p><strong>Address:</strong> ${address}</p>`;
    }
    
    if (category) {
      html += `<p><strong>Category:</strong> ${category}</p>`;
    }
    
    if (room) {
      html += `<p><strong>Room:</strong> ${room}</p>`;
    }
    
    if (coords) {
      html += `<p><strong>Coordinates:</strong> ${coords[0]}, ${coords[1]}</p>`;
    }
    
    if (!html) {
      html = '<p class="text-muted">No details available</p>';
    }
    
    document.getElementById(elementId).innerHTML = html;
  }
  
  // Update page with connection data
  function updatePageWithConnectionData(data) {
    console.log('Connection data:', data);
    
    // Check if we got valid data
    if (!data || !data.name) {
      throw new Error('Invalid or empty connection data');
    }
    
    // Update page title and header
    document.title = `${data.name} - Connection Details`;
    document.getElementById('connection-name').textContent = data.name;
    
    // Update badges
    let badgesHtml = '';
    
    // Status badge
    const statusClass = statusClasses[data.status] || statusClasses.Unknown;
    badgesHtml += `<span class="badge ${statusClass} me-2">${data.status || 'Unknown'}</span>`;
    
    // Reference badge
    if (data.reference) {
      badgesHtml += `<span class="badge bg-light text-dark me-2">Ref: ${data.reference}</span>`;
    }
    
    // Bandwidth badge
    if (data.bandwidth) {
      badgesHtml += `<span class="badge bg-info me-2">${data.bandwidth}</span>`;
    }
    
    document.getElementById('connection-badges').innerHTML = badgesHtml;
    
    // Update quick info cards
    document.getElementById('vendor-info').textContent = data.vendor || 'Not specified';
    document.getElementById('type-info').textContent = data.type_name || 'Not specified';
    document.getElementById('location-info').textContent = data.location || 'Not specified';
    document.getElementById('transport-info').textContent = data.transport_type || 'Not specified';
    
    // Update detail link
    document.getElementById('details-link').href = `/plugins/praksis-nhn-nautobot/samband/${connectionId}/`;
    
    // Find point features to get categories for proper icons
    const pointAFeature = data.features?.find(f => f.type === 'point' && f.point_type === 'A');
    const pointBFeature = data.features?.find(f => f.type === 'point' && f.point_type === 'B');
    
    // Update endpoint icons with the specific category for each point
    renderLocationIcon('point-a-icon', data.pop_a_category);
    renderLocationIcon('point-b-icon', data.pop_b_category);
    
    // Update endpoint details
    populatePointDetails('point-a-details', data, true);
    populatePointDetails('point-b-details', data, false);
    
    return data;
  }
  
  // Fetch connection data and update page
  fetch(`/plugins/praksis-nhn-nautobot/samband/map-data/?connection_id=${connectionId}`)
  .then(response => {
    if (!response.ok) {
      throw new Error(`Connection not found (Status: ${response.status})`);
    }
    return response.json();
  })
  .then(data => {
    console.log('Raw data from API:', data);
    
    // Provide informative error if data structure is missing expected fields
    if (!data) {
      throw new Error('No data returned from API');
    }
    
    // Check for required coordinates
    if (!data.pop_a_coords && !data.pop_b_coords) {
      console.warn('No valid coordinates found for this connection');
    }
    
    updatePageWithConnectionData(data);
    
    // Use the simplified API response for map rendering
    renderConnectionMap(data);
  })
    .catch(error => {
      console.error('Error loading connection:', error);
      document.getElementById('connection-name').textContent = 'Error Loading Connection';
      document.getElementById('connection-badges').innerHTML = '<span class="badge bg-danger">Error</span>';
      document.getElementById('quick-info').innerHTML = `
        <div class="col-12">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> 
            ${error.message || 'Error loading connection details.'}
          </div>
        </div>
      `;
      
      // Show error on map
      if (!map) map = initMap();
      map.setView([65.4, 17.0], 5);
      
      // Show error in point details
      document.getElementById('point-a-details').innerHTML = '<p class="text-danger">Could not load point details</p>';
      document.getElementById('point-b-details').innerHTML = '<p class="text-danger">Could not load point details</p>';
      document.getElementById('point-a-icon').innerHTML = '<i class="fa-solid fa-exclamation-circle" style="color: #dc3545; font-size: 14px;"></i>';
      document.getElementById('point-b-icon').innerHTML = '<i class="fa-solid fa-exclamation-circle" style="color: #dc3545; font-size: 14px;"></i>';
    });
});
</script>
{% endblock %}