{% extends 'base.html' %}
{% load static %}

{% block title %}Connection Details{% endblock %}

{% block content %}
<!-- Page header with connection name and details -->
<div class="container-fluid px-4 pb-2">
  <div class="row mb-3">
    <div class="col">
      <h1 class="fs-3 fw-bold mb-1" id="connection-name">Loading connection...</h1>
      <div class="d-flex align-items-center mb-2" id="connection-badges">
        <!-- Status badge will be added dynamically -->
      </div>
      
      <!-- Quick info -->
      <div class="row mb-3" id="quick-info">
        <div class="col-md-6 col-lg-3 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h5 class="card-title fs-6">Vendor</h5>
              <p class="card-text" id="vendor-info">Loading...</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h5 class="card-title fs-6">Connection Type</h5>
              <p class="card-text" id="type-info">Loading...</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h5 class="card-title fs-6">Location</h5>
              <p class="card-text" id="location-info">Loading...</p>
            </div>
          </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-2">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body">
              <h5 class="card-title fs-6">Transport Type</h5>
              <p class="card-text" id="transport-info">Loading...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Action buttons -->
    <div class="col-auto d-flex align-items-start">
      <a id="details-link" href="#" class="btn btn-primary me-2">Full Details</a>
      <a href="{% url 'plugins:praksis_nhn_nautobot:samband_client_map' %}" class="btn btn-outline-secondary">Back to Map</a>
    </div>
  </div>

  <!-- Connection map and endpoint details -->
  <div class="row">
    <!-- Map section -->
    <div class="col-lg-8 mb-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-light">
          <h5 class="card-title mb-0">Connection Map</h5>
        </div>
        <div class="card-body p-0">
          <!-- Map container -->
          <div id="connection-map" style="height: 500px; width: 100%;"></div>
          
          <!-- Error message overlay -->
          <div id="map-error" class="position-absolute top-50 start-50 translate-middle bg-white p-3 rounded shadow-sm d-none">
            <div class="text-danger mb-2"><i class="fas fa-exclamation-circle"></i> Error loading map data</div>
            <p class="mb-0 small" id="map-error-text"></p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Endpoint details section -->
    <div class="col-lg-4">
      <div class="row">
        <!-- Point A details -->
        <div class="col-12 mb-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-light">
              <div class="d-flex align-items-center">
                <div id="point-a-icon" class="me-2" style="width: 24px; height: 24px; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  <i class="fa-solid fa-spinner fa-spin" style="font-size: 14px;"></i>
                </div>
                <h5 class="card-title mb-0">Point A</h5>
              </div>
            </div>
            <div class="card-body" id="point-a-details">
              <div class="text-center">Loading point details...</div>
            </div>
          </div>
        </div>
        
        <!-- Point B details -->
        <div class="col-12 mb-4">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-light">
              <div class="d-flex align-items-center">
                <div id="point-b-icon" class="me-2" style="width: 24px; height: 24px; border-radius: 50%; background-color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                  <i class="fa-solid fa-spinner fa-spin" style="font-size: 14px;"></i>
                </div>
                <h5 class="card-title mb-0">Point B</h5>
              </div>
            </div>
            <div class="card-body" id="point-b-details">
              <div class="text-center">Loading point details...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

<script>
document.addEventListener('DOMContentLoaded', function() {
  const connectionId = "{{ connection_id }}";
  let map = null;
  
  // Status colors
  const statusColors = {
    'Active': '#4CAF50',     // Green
    'Planned': '#FFC107',    // Yellow/Amber
    'Decommissioned': '#F44336', // Red
    'Planning': '#FFC107',   // Yellow
    'Unknown': '#9E9E9E'     // Grey (fallback)
  };
  
  // Status Bootstrap classes
  const statusClasses = {
    'Active': 'bg-success',
    'Planned': 'bg-warning',
    'Decommissioned': 'bg-danger',
    'Planning': 'bg-warning',
    'Unknown': 'bg-secondary'
  };
  
  // Location type icon mapping - using only the most relevant types
  const locationTypeIcons = {
    'Hospital': {
      icon: 'fa-solid fa-hospital',
      color: '#E91E63'
    },
    'Datacenter': {
      icon: 'fa-solid fa-server',
      color: '#673AB7'
    },
    'Data Center': {
      icon: 'fa-solid fa-server',
      color: '#673AB7'
    },
    'Pharmacy': {
      icon: 'fa-solid fa-prescription-bottle-medical',
      color: '#009688'
    },
    'Primary Care': {
      icon: 'fa-solid fa-user-doctor',
      color: '#FF5722'
    },
    'Medical Imaging': {
      icon: 'fa-solid fa-x-ray',
      color: '#8BC34A'
    }
  };
  
  // Initialize map
  function initMap() {
    map = L.map('connection-map');
    
    // Add base map layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(map);
    
    return map;
  }
  
  // Helper function to get icon for location type
  function getLocationIcon(locationType) {
    const config = locationTypeIcons[locationType] || {
      icon: 'fa-solid fa-location-dot',
      color: '#3186cc'
    };
    
    return L.divIcon({
      html: `<div style="background-color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">
              <i class="${config.icon}" style="color: ${config.color}; font-size: 16px;"></i>
            </div>`,
      className: '',
      iconSize: [28, 28],
      iconAnchor: [14, 14],
      popupAnchor: [0, -14]
    });
  }
  
  // Render icon for a location
  function renderLocationIcon(elementId, category) {
    const config = locationTypeIcons[category] || {
      icon: 'fa-solid fa-location-dot',
      color: '#3186cc'
    };
    
    document.getElementById(elementId).innerHTML = `<i class="${config.icon}" style="color: ${config.color}; font-size: 14px;"></i>`;
  }
  
  // Parse coordinates from a string
  function parseCoordinates(geoString) {
    if (!geoString) return null;
    
    // Try direct comma-separated format first
    if (geoString.includes(',')) {
      const parts = geoString.split(',').map(p => p.trim());
      if (parts.length >= 2) {
        const lat = parseFloat(parts[0]);
        const lng = parseFloat(parts[1]);
        if (!isNaN(lat) && !isNaN(lng)) {
          return [lat, lng];
        }
      }
    }
    
    // Try to extract from an address string with commas (look for patterns like "60.1234, 5.6789")
    const matches = geoString.match(/(\d+\.\d+)[,\s]+(\d+\.\d+)/);
    if (matches && matches.length >= 3) {
      const lat = parseFloat(matches[1]);
      const lng = parseFloat(matches[2]);
      if (!isNaN(lat) && !isNaN(lng)) {
        return [lat, lng];
      }
    }
    
    return null;
  }
  
  // Show map error
  function showMapError(message) {
    const errorEl = document.getElementById('map-error');
    document.getElementById('map-error-text').textContent = message;
    errorEl.classList.remove('d-none');
  }
  
  // Hide map error
  function hideMapError() {
    document.getElementById('map-error').classList.add('d-none');
  }

  // Populate details for a connection point
  function populatePointDetails(elementId, data, isPointA) {
    const address = isPointA ? data.pop_a_address : data.pop_b_address;
    const category = isPointA ? data.pop_a_category : data.pop_b_category;
    const room = isPointA ? data.pop_a_room : data.pop_b_room;

    console.log('all data:', data);
    
    let html = '';
    
    if (address) {
      html += `<p><strong>Address:</strong> ${address}</p>`;
    }
    
    if (category) {
      html += `<p><strong>Category:</strong> ${category}</p>`;
    }
    
    if (room) {
      html += `<p><strong>Room:</strong> ${room}</p>`;
    }
    
    // Get coordinates from the features array instead
    const pointFeature = data.features?.find(f => 
      f.type === 'point' && 
      f.point_type === (isPointA ? 'A' : 'B')
    );
    
    if (pointFeature && pointFeature.location) {
      const [lat, lng] = pointFeature.location;
      html += `<p><strong>Coordinates:</strong> ${lat}, ${lng}</p>`;
    }
    
    if (!html) {
      html = '<p class="text-muted">No details available</p>';
    }
    
    document.getElementById(elementId).innerHTML = html;
  }
  
  // Update page with connection data
  function updatePageWithConnectionData(data) {
    console.log('Connection data:', data);
    
    // Check if we got valid data
    if (!data || !data.name) {
      throw new Error('Invalid or empty connection data');
    }
    
    // Update page title and header
    document.title = `${data.name} - Connection Details`;
    document.getElementById('connection-name').textContent = data.name;
    
    // Update badges
    let badgesHtml = '';
    
    // Status badge
    const statusClass = statusClasses[data.status] || statusClasses.Unknown;
    badgesHtml += `<span class="badge ${statusClass} me-2">${data.status || 'Unknown'}</span>`;
    
    // Reference badge
    if (data.reference) {
      badgesHtml += `<span class="badge bg-light text-dark me-2">Ref: ${data.reference}</span>`;
    }
    
    // Bandwidth badge
    if (data.bandwidth) {
      badgesHtml += `<span class="badge bg-info me-2">${data.bandwidth}</span>`;
    }
    
    document.getElementById('connection-badges').innerHTML = badgesHtml;
    
    // Update quick info cards
    document.getElementById('vendor-info').textContent = data.vendor || 'Not specified';
    document.getElementById('type-info').textContent = data.type_name || 'Not specified';
    document.getElementById('location-info').textContent = data.location || 'Not specified';
    document.getElementById('transport-info').textContent = data.transport_type || 'Not specified';
    
    // Update detail link
    document.getElementById('details-link').href = `/plugins/praksis-nhn-nautobot/samband/${connectionId}/`;
    
    // Find point features to get categories for proper icons
    const pointAFeature = data.features?.find(f => f.type === 'point' && f.point_type === 'A');
    const pointBFeature = data.features?.find(f => f.type === 'point' && f.point_type === 'B');
    
    // Update endpoint icons with the specific category for each point
    renderLocationIcon('point-a-icon', pointAFeature?.category || data.pop_a_category);
    renderLocationIcon('point-b-icon', pointBFeature?.category || data.pop_b_category);
    
    // Update endpoint details
    populatePointDetails('point-a-details', data, true);
    populatePointDetails('point-b-details', data, false);
    
    return data;
  }
  
  // Render map features based on connection data
  function renderMapFeatures(features, data) {
    // Initialize map if not already done
    if (!map) map = initMap();
    
    const bounds = [];
    const statusColor = statusColors[data.status] || statusColors.Unknown;
    
    // Hide any previous errors
    hideMapError();
    
    // Process each feature (points and lines)
    features.forEach(feature => {
      if (feature.type === 'point') {
        // Get the proper category for this point
        const pointCategory = feature.category || 
            (feature.point_type === 'A' ? data.pop_a_category : data.pop_b_category);
        
        // This is a point feature (A or B)
        const marker = L.marker(feature.location, {
          // Use point-specific category instead of global location_type
          icon: getLocationIcon(pointCategory)
        }).bindPopup(`
          <div style="min-width: 200px;">
            <strong>${feature.name} - Point ${feature.point_type}</strong><br>
            ${feature.address ? `<strong>Address:</strong> ${feature.address}<br>` : ''}
            ${feature.category ? `<strong>Category:</strong> ${feature.category}<br>` : ''}
            ${feature.room ? `<strong>Room:</strong> ${feature.room}` : ''}
          </div>
        `).addTo(map);
        
        bounds.push(feature.location);
      } else if (feature.type === 'line') {
        // This is a line connecting points
        L.polyline(feature.points, {
          color: statusColor,
          weight: 4,
          opacity: 0.8,
          smoothFactor: 1
        }).bindPopup(`
          <div style="min-width: 200px;">
            <strong>${feature.name}</strong><br>
            <strong>Status:</strong> ${data.status || 'Unknown'}<br>
            <strong>Vendor:</strong> ${data.vendor || 'Not specified'}<br>
            <strong>Type:</strong> ${data.type_name || 'Not specified'}
          </div>
        `).addTo(map);
      }
    });
    
    // Set map view
    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [30, 30] });
    } else {
      map.setView([65.4, 17.0], 5);
      
      // Show message if no valid coordinates
      L.marker([65.4, 17.0])
        .bindPopup("No valid coordinates available for this connection")
        .addTo(map)
        .openPopup();
    }
  }
  
  // Fetch connection data and update page
  fetch(`/plugins/praksis-nhn-nautobot/samband/map-data/?connection_id=${connectionId}`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`Connection not found (Status: ${response.status})`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Raw data from API:', data);
      
      // Provide informative error if data structure is missing expected fields
      if (!data) {
        throw new Error('No data returned from API');
      }
      
      if (!data.features) {
        throw new Error('No features array found in the API response');
      }
      
      updatePageWithConnectionData(data);
      
      // Use the features array for map rendering
      if (data.features && data.features.length > 0) {
        renderMapFeatures(data.features, data);
      } else {
        showMapError('No valid map features found for this connection');
      }
    })
    .catch(error => {
      console.error('Error loading connection:', error);
      document.getElementById('connection-name').textContent = 'Error Loading Connection';
      document.getElementById('connection-badges').innerHTML = '<span class="badge bg-danger">Error</span>';
      document.getElementById('quick-info').innerHTML = `
        <div class="col-12">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> 
            ${error.message || 'Error loading connection details.'}
          </div>
        </div>
      `;
      
      // Show error on map
      if (!map) map = initMap();
      map.setView([65.4, 17.0], 5);
      showMapError(error.message || 'Failed to load connection data.');
      
      // Show error in point details
      document.getElementById('point-a-details').innerHTML = '<p class="text-danger">Could not load point details</p>';
      document.getElementById('point-b-details').innerHTML = '<p class="text-danger">Could not load point details</p>';
      document.getElementById('point-a-icon').innerHTML = '<i class="fa-solid fa-exclamation-circle" style="color: #dc3545; font-size: 14px;"></i>';
      document.getElementById('point-b-icon').innerHTML = '<i class="fa-solid fa-exclamation-circle" style="color: #dc3545; font-size: 14px;"></i>';
    });
});
</script>
{% endblock %}